<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consola Administrativa - Parking</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="layout-admin">
    <nav class="sidebar-admin">
        <h2>Men칰 Empleado</h2>
        <ul>
            <li class="menu-item active" data-section="ingreso-salida"><a href="#">Ingreso/Salida</a></li>
            <li class="menu-item" data-section="vehiculos"><a href="#">Veh칤culos</a></li>
            <li class="menu-item" data-section="espacios"><a href="#">Espacios ocupados</a></li>
            <li class="menu-item" data-section="facturacion"><a href="#">Facturaci칩n</a>
                <ul class="submenu" style="display: none;">
                    <li class="submenu-item active" data-section="facturacion-ganancias"><a href="#">Facturaci칩n y Ganancias</a></li>
                    <li class="submenu-item" data-section="tickets"><a href="#">Tickets</a></li>
                </ul>
            </li>
            <li class="menu-item" data-section="administracion"><a href="#">Administraci칩n</a>
                <ul class="submenu" style="display: none;">
                    <li class="submenu-item active" data-section="config-parqueadero"><a href="#">Configuraci칩n Parqueadero</a></li>
                    <li class="submenu-item" data-section="tarifas"><a href="#">Tarifas</a></li>
                    <li class="submenu-item" data-section="proveedores"><a href="#">Proveedores</a></li>
                    <li class="submenu-item" data-section="servicios-programados"><a href="#">Servicios Programados</a></li>
                </ul>
            </li>
            <li><a href="/">Cerrar Sesi칩n</a></li>
        </ul>
    </nav>
    <section class="panel-zona">
      <div class="panel-zona-inner">
        <!-- SECCI칍N INGRESO/SALIDA -->
        <div id="section-ingreso-salida" class="section-content active">
          <div class="ingreso-salida-container">
            <!-- SELECTOR DE PARQUEADERO Y ESTAD칈STICAS -->
            <div class="admin-card-box parqueadero-info-card">
                <!-- SELECTOR DE PARQUEADERO (se muestra inicialmente) -->
                <div id="selectorParqueadero">
                    <h3>Seleccionar Parqueadero</h3>
                    <label class="field-label" for="selectParqueadero">Parqueadero</label>
                    <select class="input-admin" id="selectParqueadero" name="parqueadero" required>
                        <option value="">-- Seleccione un parqueadero --</option>
                    </select>
                </div>
                
                <!-- INFORMACI칍N DEL PARQUEADERO (se oculta inicialmente) -->
                <div id="infoParqueadero" class="info-parqueadero-box" style="display: none;">
                    <div class="parqueadero-header-contenedor">
                        <div>
                            <div id="parqueaderoNombre" class="parqueadero-nombre"></div>
                            <div id="parqueaderoDireccion" class="parqueadero-direccion"></div>
                        </div>
                        <button type="button" id="btnCambiarParqueadero" class="btn-cambiar-parqueadero">Cambiar</button>
                    </div>
                    <div class="contadores-container">
                        <div class="contador-box">
                            <div class="contador-label">Ingresados</div>
                            <div id="contadorIngresados" class="contador-valor contador-principal">0</div>
                        </div>
                        <div class="contador-box">
                            <div class="contador-label">Disponibles</div>
                            <div id="contadorDisponibles" class="contador-valor contador-exito">0</div>
                        </div>
                        <div class="contador-box">
                            <div class="contador-label">Capacidad</div>
                            <div id="capacidadTotal" class="contador-valor contador-texto">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- CONTENEDOR DE INGRESO Y SALIDA -->
            <div class="formularios-container">
              <!-- INGRESO VEH칈CULO -->
              <div class="admin-card-box formulario-box" id="cardIngreso" style="opacity: 0.5; pointer-events: none;">
                  <h3>Ingreso</h3>
                  <form id="formIngreso">
                      <label class="field-label" for="ingresoPlaca">Placa</label>
                      <input class="input-admin" type="text" id="ingresoPlaca" name="placa" placeholder="Ej: ABC123" maxlength="20" required disabled>
                      <small id="hintPlaca" style="display: block; margin-top: 5px; color: #666; font-size: 0.85rem;"></small>

                      <label class="field-label" for="ingresoTipo">Tipo de Veh칤culo</label>
                      <select class="input-admin" id="ingresoTipo" name="tipo_vehiculo" required disabled>
                        <option value="Automovil">Autom칩vil</option>
                        <option value="Motocicleta">Motocicleta</option>
                        <option value="Camion">Cami칩n</option>
                        <option value="Bicicleta">Bicicleta</option>
                      </select>
                      <button class="admin-btn" type="submit" disabled>Registrar ingreso</button>
                      <div class="info-ingreso" id="msgIngreso"></div>
                  </form>
              </div>
              <!-- SALIDA VEH칈CULO -->
              <div class="admin-card-box formulario-box" id="cardSalida" style="opacity: 0.5; pointer-events: none;">
                  <h3>Salida</h3>
                  <form id="formSalida">
                      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                          <button type="button" id="btnBuscarPorPlaca" class="admin-btn" style="flex: 1; background: var(--color-botones-sec);" disabled>Por Placa</button>
                          <button type="button" id="btnBuscarPorTicket" class="admin-btn" style="flex: 1; background: var(--color-fondo-claro); color: var(--color-principal);" disabled>Por Ticket</button>
                      </div>
                      
                      <div id="campoPlacaSalida" style="display: block;">
                          <label class="field-label" for="salidaPlaca">Placa</label>
                          <input class="input-admin" type="text" id="salidaPlaca" name="placa" placeholder="Ej: ABC123" maxlength="20" disabled>
                      </div>
                      
                      <div id="campoTicketSalida" style="display: none;">
                          <label class="field-label" for="salidaTicket">N칰mero de Ticket</label>
                          <input class="input-admin" type="text" id="salidaTicket" name="ticket" placeholder="Ej: 123" maxlength="10" disabled>
                      </div>
                      
                      <button class="admin-btn" type="submit" disabled>Generar factura salida</button>
                      <div class="info-salida" id="msgSalida"></div>
                  </form>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N VEH칈CULOS -->
        <div id="section-vehiculos" class="section-content" style="display: none;">
          <div class="vehiculos-container">
            <div class="admin-card-box" style="width: 100%; max-width: 100%;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Veh칤culos Ingresados</h3>
                <button class="admin-btn" id="btnActualizarVehiculos" style="width: auto; padding: 10px 20px; margin: 0;">游댃 Actualizar</button>
              </div>
              <div id="vehiculosLista" class="vehiculos-lista">
                <div class="loading-vehiculos">Cargando veh칤culos...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N ESPACIOS OCUPADOS -->
        <div id="section-espacios" class="section-content" style="display: none;">
          <div class="espacios-container">
            <div class="admin-card-box full-width">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Estad칤sticas de Espacios Ocupados</h3>
                <button class="admin-btn" id="btnActualizarEspacios" style="width: auto; padding: 10px 20px; margin: 0;">游댃 Actualizar</button>
              </div>
              <div id="estadisticasEspacios" class="estadisticas-espacios">
                <div class="loading-vehiculos">Cargando estad칤sticas...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N FACTURACI칍N Y GANANCIAS -->
        <div id="section-facturacion-ganancias" class="section-content" style="display: none;">
          <div class="facturacion-container">
            <!-- FILTROS Y RESUMEN -->
            <div class="admin-card-box full-width">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h3>Facturaci칩n y Ganancias</h3>
                <button class="admin-btn" id="btnActualizarFacturacion" style="width: auto; padding: 10px 20px; margin: 0;">游댃 Actualizar</button>
              </div>
              
              <!-- Filtros -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                  <label class="field-label" for="filtroFechaInicio">Fecha Inicio</label>
                  <input class="input-admin" type="date" id="filtroFechaInicio">
                </div>
                <div>
                  <label class="field-label" for="filtroFechaFin">Fecha Fin</label>
                  <input class="input-admin" type="date" id="filtroFechaFin">
                </div>
                <div>
                  <label class="field-label" for="filtroParqueadero">Parqueadero</label>
                  <select class="input-admin" id="filtroParqueadero">
                    <option value="">Todos los parqueaderos</option>
                  </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                  <button class="admin-btn" id="btnAplicarFiltros" style="width: 100%;">Aplicar Filtros</button>
                </div>
              </div>

              <!-- Resumen de Ganancias -->
              <div id="resumenGanancias" class="resumen-ganancias">
                <div class="resumen-item-ganancia">
                  <div class="resumen-label-ganancia">Total Facturado</div>
                  <div class="resumen-valor-ganancia" id="totalFacturado">$0</div>
                </div>
                <div class="resumen-item-ganancia">
                  <div class="resumen-label-ganancia">Promedio Diario</div>
                  <div class="resumen-valor-ganancia" id="promedioDiario">$0</div>
                </div>
                <div class="resumen-item-ganancia">
                  <div class="resumen-label-ganancia">Total Facturas</div>
                  <div class="resumen-valor-ganancia" id="totalFacturas">0</div>
                </div>
                <div class="resumen-item-ganancia">
                  <div class="resumen-label-ganancia">Mejor D칤a</div>
                  <div class="resumen-valor-ganancia" id="mejorDia">-</div>
                </div>
              </div>
            </div>

            <!-- GR츼FICOS -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; margin-top: 24px;">
              <!-- Gr치fico de L칤nea - Ganancias por D칤a -->
              <div class="admin-card-box full-width">
                <h3>Ganancias por D칤a</h3>
                <canvas id="graficoLinea"></canvas>
              </div>

              <!-- Gr치fico de Barras - Ganancias por Parqueadero -->
              <div class="admin-card-box full-width">
                <h3>Ganancias por Parqueadero</h3>
                <canvas id="graficoBarras"></canvas>
              </div>

              <!-- Gr치fico de Pastel - Ganancias por Tipo de Veh칤culo -->
              <div class="admin-card-box full-width">
                <h3>Ganancias por Tipo de Veh칤culo</h3>
                <canvas id="graficoPastel"></canvas>
              </div>
            </div>

            <!-- TABLA DE FACTURAS -->
            <div class="admin-card-box full-width" style="margin-top: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Historial de Facturas</h3>
              </div>
              <div id="tablaFacturas" class="lista-parqueaderos">
                <div class="loading-vehiculos">Cargando facturas...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N TICKETS -->
        <div id="section-tickets" class="section-content" style="display: none;">
          <div class="tickets-container">
            <div class="admin-card-box full-width">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h3>Gesti칩n de Tickets</h3>
                <button class="admin-btn" id="btnActualizarTickets" style="width: auto; padding: 10px 20px; margin: 0;">游댃 Actualizar</button>
              </div>
              
              <!-- Filtros -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                  <label class="field-label" for="filtroTicketEstado">Estado</label>
                  <select class="input-admin" id="filtroTicketEstado">
                    <option value="">Todos los estados</option>
                    <option value="Activo">Activo</option>
                    <option value="Cerrado">Cerrado</option>
                  </select>
                </div>
                <div>
                  <label class="field-label" for="filtroTicketParqueadero">Parqueadero</label>
                  <select class="input-admin" id="filtroTicketParqueadero">
                    <option value="">Todos los parqueaderos</option>
                  </select>
                </div>
                <div>
                  <label class="field-label" for="filtroTicketPlaca">Placa</label>
                  <input class="input-admin" type="text" id="filtroTicketPlaca" placeholder="Buscar por placa">
                </div>
                <div style="display: flex; align-items: flex-end;">
                  <button class="admin-btn" id="btnAplicarFiltrosTickets" style="width: 100%;">Aplicar Filtros</button>
                </div>
              </div>

              <!-- Tabla de Tickets -->
              <div id="tablaTickets" class="lista-parqueaderos">
                <div class="loading-vehiculos">Cargando tickets...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N TARIFAS -->
        <div id="section-tarifas" class="section-content" style="display: none;">
          <div class="config-parqueadero-container">
            <!-- FORMULARIO DE REGISTRO/MODIFICACI칍N -->
            <div class="admin-card-box full-width">
              <h3 id="tituloFormTarifa">Registro de Tarifa</h3>
              <form id="formTarifa">
                <input type="hidden" id="idTarifaEdit" name="idEdit">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div>
                    <label class="field-label" for="tipoTarifa">Tipo de Tarifa</label>
                    <input class="input-admin" type="text" id="tipoTarifa" name="tipo_tarifa" placeholder="Ej: Por minuto, Por hora" required>
                  </div>

                  <div>
                    <label class="field-label" for="tipoVehiculoTarifa">Tipo de Veh칤culo</label>
                    <select class="input-admin" id="tipoVehiculoTarifa" name="tipo_vehiculo" required>
                      <option value="">-- Seleccione tipo --</option>
                      <option value="Automovil">Autom칩vil</option>
                      <option value="Motocicleta">Motocicleta</option>
                      <option value="Camion">Cami칩n</option>
                      <option value="Bicicleta">Bicicleta</option>
                    </select>
                  </div>

                  <div>
                    <label class="field-label" for="valorUnitario">Valor Unitario</label>
                    <input class="input-admin" type="number" id="valorUnitario" name="valor_unitario" step="0.01" min="0" placeholder="Ej: 100.00" required>
                  </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button class="admin-btn" type="submit" id="btnGuardarTarifa">Registrar Tarifa</button>
                  <button class="admin-btn" type="button" id="btnCancelarEdicionTarifa" style="background: var(--color-botones-sec); display: none;">Cancelar</button>
                </div>
                <div class="info-registro" id="msgTarifa"></div>
              </form>
            </div>

            <!-- LISTA DE TARIFAS -->
            <div class="admin-card-box full-width" style="margin-top: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Tarifas Registradas</h3>
                <button class="admin-btn" id="btnActualizarTarifas" style="width: auto; padding: 10px 20px; margin: 0;">游댃 Actualizar</button>
              </div>
              <div id="listaTarifas" class="lista-parqueaderos">
                <div class="loading-vehiculos">Cargando tarifas...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N PROVEEDORES -->
        <div id="section-proveedores" class="section-content" style="display: none;">
          <div class="config-parqueadero-container">
            <!-- FORMULARIO DE REGISTRO/MODIFICACI칍N -->
            <div class="admin-card-box full-width">
              <h3 id="tituloFormProveedor">Registro de Proveedor</h3>
              <form id="formProveedor">
                <input type="hidden" id="idProveedorEdit" name="idEdit">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div>
                    <label class="field-label" for="nombreProveedor">Nombre del Proveedor *</label>
                    <input class="input-admin" type="text" id="nombreProveedor" name="nombre_proveedor" placeholder="Ej: Mantenimiento ABC" required>
                  </div>

                  <div>
                    <label class="field-label" for="tipoServicioProveedor">Tipo de Servicio</label>
                    <input class="input-admin" type="text" id="tipoServicioProveedor" name="tipo_servicio" placeholder="Ej: Mantenimiento, Limpieza, Seguridad">
                  </div>

                  <div>
                    <label class="field-label" for="telefonoProveedor">Tel칠fono</label>
                    <input class="input-admin" type="text" id="telefonoProveedor" name="telefono" placeholder="Ej: 3001234567">
                  </div>

                  <div>
                    <label class="field-label" for="emailProveedor">Email</label>
                    <input class="input-admin" type="email" id="emailProveedor" name="email" placeholder="Ej: proveedor@ejemplo.com">
                  </div>

                  <div>
                    <label class="field-label" for="parqueaderoProveedor">Parqueadero *</label>
                    <select class="input-admin" id="parqueaderoProveedor" name="id_parqueadero" required>
                      <option value="">-- Seleccione un parqueadero --</option>
                    </select>
                  </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button class="admin-btn" type="submit" id="btnGuardarProveedor">Registrar Proveedor</button>
                  <button class="admin-btn" type="button" id="btnCancelarEdicionProveedor" style="background: var(--color-botones-sec); display: none;">Cancelar</button>
                </div>
                <div class="info-registro" id="msgProveedor"></div>
              </form>
            </div>

            <!-- LISTA DE PROVEEDORES -->
            <div class="admin-card-box full-width" style="margin-top: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Proveedores Registrados</h3>
                <button class="admin-btn" id="btnActualizarProveedores" style="width: auto; padding: 10px 20px; margin: 0;">游댃 Actualizar</button>
              </div>
              <div id="listaProveedores" class="lista-parqueaderos">
                <div class="loading-vehiculos">Cargando proveedores...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N SERVICIOS PROGRAMADOS -->
        <div id="section-servicios-programados" class="section-content" style="display: none;">
          <div class="config-parqueadero-container">
            <!-- FORMULARIO DE REGISTRO/MODIFICACI칍N -->
            <div class="admin-card-box full-width">
              <h3 id="tituloFormServicio">Registro de Servicio Programado</h3>
              <form id="formServicio">
                <input type="hidden" id="idServicioEdit" name="idEdit">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div>
                    <label class="field-label" for="proveedorServicio">Proveedor *</label>
                    <select class="input-admin" id="proveedorServicio" name="id_proveedor" required>
                      <option value="">-- Seleccione un proveedor --</option>
                    </select>
                  </div>

                  <div>
                    <label class="field-label" for="fechaProgramada">Fecha Programada *</label>
                    <input class="input-admin" type="date" id="fechaProgramada" name="fecha_programada" required>
                  </div>

                  <div>
                    <label class="field-label" for="horaProgramada">Hora Programada *</label>
                    <input class="input-admin" type="time" id="horaProgramada" name="hora_programada" required>
                  </div>

                  <div>
                    <label class="field-label" for="estadoServicio">Estado</label>
                    <select class="input-admin" id="estadoServicio" name="estado">
                      <option value="Programado">Programado</option>
                      <option value="En Proceso">En Proceso</option>
                      <option value="Completado">Completado</option>
                      <option value="Cancelado">Cancelado</option>
                    </select>
                  </div>

                  <div style="grid-column: 1 / -1;">
                    <label class="field-label" for="descripcionServicio">Descripci칩n del Servicio *</label>
                    <textarea class="input-admin" id="descripcionServicio" name="descripcion_servicio" rows="3" placeholder="Describa el servicio a realizar..." required></textarea>
                  </div>

                  <div style="grid-column: 1 / -1;">
                    <label class="field-label" for="observacionesServicio">Observaciones</label>
                    <textarea class="input-admin" id="observacionesServicio" name="observaciones" rows="2" placeholder="Observaciones adicionales..."></textarea>
                  </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button class="admin-btn" type="submit" id="btnGuardarServicio">Registrar Servicio</button>
                  <button class="admin-btn" type="button" id="btnCancelarEdicionServicio" style="background: var(--color-botones-sec); display: none;">Cancelar</button>
                </div>
                <div class="info-registro" id="msgServicio"></div>
              </form>
            </div>

            <!-- FILTROS Y LISTA DE SERVICIOS -->
            <div class="admin-card-box full-width" style="margin-top: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h3>Servicios Programados</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <select class="input-admin" id="filtroEstadoServicio" style="width: auto; min-width: 150px;">
                    <option value="">Todos los estados</option>
                    <option value="Programado">Programado</option>
                    <option value="En Proceso">En Proceso</option>
                    <option value="Completado">Completado</option>
                    <option value="Cancelado">Cancelado</option>
                  </select>
                  <select class="input-admin" id="filtroProveedorServicio" style="width: auto; min-width: 200px;">
                    <option value="">Todos los proveedores</option>
                  </select>
                  <input class="input-admin" type="date" id="filtroFechaInicio" style="width: auto;">
                  <input class="input-admin" type="date" id="filtroFechaFin" style="width: auto;">
                  <button class="admin-btn" id="btnFiltrarServicios" style="width: auto; padding: 10px 20px; margin: 0;">游댌 Filtrar</button>
                  <button class="admin-btn" id="btnActualizarServicios" style="width: auto; padding: 10px 20px; margin: 0;">游댃 Actualizar</button>
                </div>
              </div>
              <div id="listaServicios" class="lista-parqueaderos">
                <div class="loading-vehiculos">Cargando servicios programados...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N CONFIGURACI칍N PARQUEADERO -->
        <div id="section-config-parqueadero" class="section-content" style="display: none;">
          <div class="config-parqueadero-container">
            <!-- FORMULARIO DE REGISTRO/MODIFICACI칍N -->
            <div class="admin-card-box full-width">
              <h3 id="tituloFormParqueadero">Registro de Parqueadero</h3>
              <form id="formParqueadero">
                <input type="hidden" id="idParqueaderoEdit" name="idEdit">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div>
                    <label class="field-label" for="idParqueadero">ID del Parqueadero (Opcional)</label>
                    <input class="input-admin" type="text" id="idParqueadero" name="id" placeholder="Dejar vac칤o para auto-generar">
                  </div>

                  <div>
                    <label class="field-label" for="nombreParqueadero">Nombre del Parqueadero</label>
                    <input class="input-admin" type="text" id="nombreParqueadero" name="nombre" required>
                  </div>

                  <div>
                    <label class="field-label" for="horario">Horario</label>
                    <input class="input-admin" type="text" id="horario" name="horario" placeholder="Ej: 8:00 AM - 10:00 PM" required>
                  </div>

                  <div>
                    <label class="field-label" for="capacidad">Capacidad</label>
                    <input class="input-admin" type="number" id="capacidad" name="capacidad" required>
                  </div>

                  <div>
                    <label class="field-label" for="ubicacion">Direcci칩n</label>
                    <input class="input-admin" type="text" id="ubicacion" name="direccion" required>
                  </div>

                  <div>
                    <label class="field-label" for="tipo">Tipo de Parqueadero</label>
                    <select class="input-admin" id="tipo" name="tipo" required>
                      <option value="Publico">P칰blico</option>
                      <option value="Privado">Privado</option>
                      <option value="Mixto">Mixto</option>
                    </select>
                  </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button class="admin-btn" type="submit" id="btnGuardarParqueadero">Registrar Parqueadero</button>
                  <button class="admin-btn" type="button" id="btnCancelarEdicion" style="background: var(--color-botones-sec); display: none;">Cancelar</button>
                </div>
                <div class="info-registro" id="msgRegistro"></div>
              </form>
            </div>

            <!-- LISTA DE PARQUEADEROS -->
            <div class="admin-card-box full-width" style="margin-top: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Parqueaderos Registrados</h3>
                <button class="admin-btn" id="btnActualizarParqueaderos" style="width: auto; padding: 10px 20px; margin: 0;">游댃 Actualizar</button>
              </div>
              <div id="listaParqueaderos" class="lista-parqueaderos">
                <div class="loading-vehiculos">Cargando parqueaderos...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ---------- Navegaci칩n por secciones ----------
    const menuItems = document.querySelectorAll('.menu-item');
    const submenuItems = document.querySelectorAll('.submenu-item');
    const sections = document.querySelectorAll('.section-content');
    const allSubmenus = document.querySelectorAll('.submenu');
    
    // Mantener abiertos los submen칰s que tienen items activos al cargar la p치gina
    allSubmenus.forEach(submenu => {
        const hasActiveItem = submenu.querySelector('.submenu-item.active');
        if (hasActiveItem) {
            submenu.style.display = 'block';
            // Asegurar que el men칰 principal padre tambi칠n est칠 activo
            const parentMenuItem = submenu.closest('.menu-item');
            if (parentMenuItem) {
                parentMenuItem.classList.add('active');
            }
        }
    });

    // Manejo de clic en items del men칰 principal
    menuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionName = this.getAttribute('data-section');
            
            // Buscar el submen칰 dentro de este item
            const currentSubmenu = this.querySelector('.submenu');
            
            if (sectionName === 'administracion' || sectionName === 'facturacion') {
                // Si tiene submen칰, mantenerlo abierto y no hacer toggle
                if (currentSubmenu) {
                    // Cerrar otros submen칰s pero mantener este abierto
                    allSubmenus.forEach(sub => {
                        if (sub && sub !== currentSubmenu) {
                            sub.style.display = 'none';
                        }
                    });
                    
                    // Asegurar que este submen칰 est칠 visible
                    currentSubmenu.style.display = 'block';
                    
                    // Actualizar clases activas del men칰 principal
                    menuItems.forEach(mi => mi.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Si no hay ning칰n subitem activo, activar el primero
                    const activeSubItem = currentSubmenu.querySelector('.submenu-item.active');
                    if (!activeSubItem) {
                        const firstSubItem = currentSubmenu.querySelector('.submenu-item');
                        if (firstSubItem) {
                            const firstSectionName = firstSubItem.getAttribute('data-section');
                            // Ocultar todas las secciones
                            sections.forEach(sec => {
                                sec.classList.remove('active');
                                sec.style.display = 'none';
                            });
                            // Mostrar la primera secci칩n del submen칰
                            const firstSection = document.getElementById('section-' + firstSectionName);
                            if (firstSection) {
                                firstSection.classList.add('active');
                                firstSection.style.display = 'block';
                                // Activar el primer item del submen칰
                                submenuItems.forEach(smi => smi.classList.remove('active'));
                                firstSubItem.classList.add('active');
                                // Cargar datos si es necesario
                                if (firstSectionName === 'facturacion-ganancias') {
                                    cargarDatosFacturacion();
                                } else if (firstSectionName === 'tickets') {
                                    cargarTickets();
                                } else if (firstSectionName === 'config-parqueadero') {
                                    cargarListaParqueaderos();
                                } else if (firstSectionName === 'tarifas') {
                                    cargarListaTarifas();
                                } else if (firstSectionName === 'proveedores') {
                                    cargarParqueaderosParaProveedores();
                                    cargarListaProveedores();
                                } else if (firstSectionName === 'servicios-programados') {
                                    cargarProveedoresParaServicios();
                                    cargarListaServicios();
                                }
                            }
                        }
                    }
                }
                return;
            }

            // Ocultar todos los submen칰s si se hace clic en otro item
            allSubmenus.forEach(sub => {
                if (sub) sub.style.display = 'none';
            });

            // Actualizar clases activas
            menuItems.forEach(mi => mi.classList.remove('active'));
            this.classList.add('active');

            // Mostrar secci칩n correspondiente
            sections.forEach(sec => {
                sec.classList.remove('active');
                sec.style.display = 'none';
            });
            const targetSection = document.getElementById('section-' + sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                
                // Limpiar mensajes al cambiar de secci칩n
                limpiarMensajesSecciones();
                
                // Si es la secci칩n de veh칤culos, cargar datos
                if (sectionName === 'vehiculos') {
                    cargarVehiculosIngresados();
                }
                // Si es la secci칩n de configuraci칩n parqueadero, cargar lista
                if (sectionName === 'config-parqueadero') {
                    cargarListaParqueaderos();
                }
                // Si es la secci칩n de espacios ocupados, cargar estad칤sticas
                if (sectionName === 'espacios') {
                    cargarEstadisticasEspacios();
                }
                // Si es la secci칩n de tarifas, cargar lista
                if (sectionName === 'tarifas') {
                    cargarListaTarifas();
                }
            }
        });
    });

    // Manejo de clic en items del submen칰
    submenuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionName = this.getAttribute('data-section');
            
            // Encontrar el submen칰 padre y mantenerlo abierto
            const parentSubmenu = this.closest('.submenu');
            if (parentSubmenu) {
                parentSubmenu.style.display = 'block';
            }
            
            // Actualizar clases activas del submen칰
            // Solo remover active de items del mismo submen칰
            const sameSubmenuItems = parentSubmenu ? parentSubmenu.querySelectorAll('.submenu-item') : submenuItems;
            sameSubmenuItems.forEach(smi => smi.classList.remove('active'));
            this.classList.add('active');
            
            // Asegurar que el men칰 principal padre tambi칠n est칠 activo
            const parentMenuItem = this.closest('.menu-item');
            if (parentMenuItem) {
                menuItems.forEach(mi => mi.classList.remove('active'));
                parentMenuItem.classList.add('active');
            }

            // Mostrar secci칩n correspondiente
            sections.forEach(sec => {
                sec.classList.remove('active');
                sec.style.display = 'none';
            });
            const targetSection = document.getElementById('section-' + sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                
                // Limpiar mensajes al cambiar de secci칩n
                limpiarMensajesSecciones();
                
                // Si es la secci칩n de configuraci칩n parqueadero, cargar lista
                if (sectionName === 'config-parqueadero') {
                    cargarListaParqueaderos();
                }
                // Si es la secci칩n de espacios ocupados, cargar estad칤sticas
                if (sectionName === 'espacios') {
                    cargarEstadisticasEspacios();
                }
                // Si es la secci칩n de tarifas, cargar lista
                if (sectionName === 'tarifas') {
                    cargarListaTarifas();
                }
                // Si es la secci칩n de proveedores, cargar datos
                if (sectionName === 'proveedores') {
                    cargarParqueaderosParaProveedores();
                    cargarListaProveedores();
                }
                // Si es la secci칩n de servicios programados, cargar datos
                if (sectionName === 'servicios-programados') {
                    cargarProveedoresParaServicios();
                    cargarListaServicios();
                }
                // Si es la secci칩n de facturaci칩n y ganancias, cargar datos
                if (sectionName === 'facturacion-ganancias') {
                    cargarDatosFacturacion();
                }
                // Si es la secci칩n de tickets, cargar datos
                if (sectionName === 'tickets') {
                    cargarTickets();
                }
            }
        });
    });

    // Funci칩n para limpiar mensajes de todas las secciones
    function limpiarMensajesSecciones() {
        const msgRegistro = document.getElementById('msgRegistro');
        if (msgRegistro) {
            msgRegistro.textContent = '';
            msgRegistro.style.color = '';
        }
        const msgTarifa = document.getElementById('msgTarifa');
        if (msgTarifa) {
            msgTarifa.textContent = '';
            msgTarifa.style.color = '';
        }
    }

    // ---------- Cargar Parqueaderos ----------
    const selectParqueadero = document.getElementById('selectParqueadero');
    let parqueaderoSeleccionado = null;

    function cargarParqueaderos() {
        fetch('/obtener-parqueaderos-activos')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    selectParqueadero.innerHTML = '<option value="">-- Seleccione un parqueadero --</option>';
                    data.parqueaderos.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id_parqueadero;
                        option.textContent = `${p.nombre} - ${p.direccion}`;
                        selectParqueadero.appendChild(option);
                    });
                }
            })
            .catch(err => {
                console.error('Error cargando parqueaderos:', err);
            });
    }

    // Cargar parqueaderos al iniciar
    cargarParqueaderos();

    // Funci칩n para mostrar selector y ocultar informaci칩n
    function mostrarSelector() {
        const selectorParqueadero = document.getElementById('selectorParqueadero');
        const infoParqueadero = document.getElementById('infoParqueadero');
        const cardIngreso = document.getElementById('cardIngreso');
        const cardSalida = document.getElementById('cardSalida');
        
        selectorParqueadero.style.display = 'block';
        infoParqueadero.style.display = 'none';
        
        // Deshabilitar formularios
        cardIngreso.style.opacity = '0.5';
        cardIngreso.style.pointerEvents = 'none';
        cardSalida.style.opacity = '0.5';
        cardSalida.style.pointerEvents = 'none';
        
        const inputsIngreso = formIngreso.querySelectorAll('input, select, button');
        inputsIngreso.forEach(input => input.disabled = true);
        
        const inputsSalida = formSalida.querySelectorAll('input, button');
        inputsSalida.forEach(input => input.disabled = true);
        
        // Limpiar selector
        selectParqueadero.value = '';
        
        // Detener actualizaci칩n de estad칤sticas
        if (window.intervalEstadisticas) {
            clearInterval(window.intervalEstadisticas);
            window.intervalEstadisticas = null;
        }
    }

    // Funci칩n para mostrar informaci칩n y ocultar selector
    function mostrarInfoParqueadero(idParqueadero) {
        const selectorParqueadero = document.getElementById('selectorParqueadero');
        const infoParqueadero = document.getElementById('infoParqueadero');
        const cardIngreso = document.getElementById('cardIngreso');
        const cardSalida = document.getElementById('cardSalida');
        
        selectorParqueadero.style.display = 'none';
        infoParqueadero.style.display = 'block';
        
        // Habilitar formularios
        cardIngreso.style.opacity = '1';
        cardIngreso.style.pointerEvents = 'auto';
        cardSalida.style.opacity = '1';
        cardSalida.style.pointerEvents = 'auto';
        
        const inputsIngreso = formIngreso.querySelectorAll('input, select, button');
        inputsIngreso.forEach(input => input.disabled = false);
        
        const inputsSalida = formSalida.querySelectorAll('input, button');
        inputsSalida.forEach(input => input.disabled = false);

        // Cargar informaci칩n del parqueadero y estad칤sticas
        cargarInfoParqueadero(idParqueadero);
        actualizarEstadisticas(idParqueadero);
        
        // Actualizar estad칤sticas cada 5 segundos
        if (window.intervalEstadisticas) {
            clearInterval(window.intervalEstadisticas);
        }
        window.intervalEstadisticas = setInterval(() => {
            actualizarEstadisticas(idParqueadero);
        }, 5000);
    }

    // Manejar cambio de parqueadero
    selectParqueadero.addEventListener('change', function() {
        const idParqueadero = this.value;
        if (idParqueadero) {
            mostrarInfoParqueadero(idParqueadero);
        }
    });

    // Bot칩n cambiar parqueadero
    const btnCambiarParqueadero = document.getElementById('btnCambiarParqueadero');
    btnCambiarParqueadero.addEventListener('click', function() {
        mostrarSelector();
    });

    function cargarInfoParqueadero(idParqueadero) {
        fetch(`/obtener-parqueadero/${idParqueadero}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    parqueaderoSeleccionado = data.parqueadero;
                    document.getElementById('parqueaderoNombre').textContent = data.parqueadero.nombre;
                    document.getElementById('parqueaderoDireccion').textContent = data.parqueadero.direccion;
                    document.getElementById('capacidadTotal').textContent = data.parqueadero.capacidad_total || 0;
                    document.getElementById('infoParqueadero').style.display = 'block';
                }
            })
            .catch(err => {
                console.error('Error cargando informaci칩n del parqueadero:', err);
            });
    }

    function actualizarEstadisticas(idParqueadero) {
        fetch(`/estadisticas-parqueadero/${idParqueadero}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('contadorIngresados').textContent = data.vehiculosIngresados || 0;
                    const disponibles = (parqueaderoSeleccionado?.capacidad_total || 0) - (data.vehiculosIngresados || 0);
                    document.getElementById('contadorDisponibles').textContent = Math.max(0, disponibles);
                }
            })
            .catch(err => {
                console.error('Error actualizando estad칤sticas:', err);
            });
    }

    // ---------- Validaci칩n de placas ----------
    function validarFormatoPlaca(placa, tipoVehiculo) {
        const placaUpper = placa.trim().toUpperCase();
        
        if (tipoVehiculo === 'Bicicleta') {
            // Detectar si la placa ingresada coincide con formato de autom칩vil/cami칩n (3 letras + 3 n칰meros)
            const regexAutoCamion = /^[A-Z]{3}[0-9]{3}$/;
            if (regexAutoCamion.test(placaUpper)) {
                return { 
                    valido: false, 
                    mensaje: `La placa "${placaUpper}" coincide con el formato de Autom칩vil/Cami칩n (3 letras + 3 n칰meros). 쮻esea cambiar el tipo de veh칤culo a Autom칩vil?`,
                    sugerenciaCambioTipo: 'Automovil'
                };
            }
            
            // Detectar si la placa ingresada coincide con formato de motocicleta (3 letras + 2 n칰meros + 1 letra)
            const regexMoto = /^[A-Z]{3}[0-9]{2}[A-Z]{1}$/;
            if (regexMoto.test(placaUpper)) {
                return { 
                    valido: false, 
                    mensaje: `La placa "${placaUpper}" coincide con el formato de Motocicleta (3 letras + 2 n칰meros + 1 letra). 쮻esea cambiar el tipo de veh칤culo a Motocicleta?`,
                    sugerenciaCambioTipo: 'Motocicleta'
                };
            }
            
            // Para bicicleta, no hay requisito m칤nimo de caracteres, acepta cualquier texto
            return { valido: true, placa: placaUpper };
        }
        
        if (tipoVehiculo === 'Automovil' || tipoVehiculo === 'Camion') {
            // Formato: 3 letras + 3 n칰meros (ABC123)
            const regex = /^[A-Z]{3}[0-9]{3}$/;
            if (regex.test(placaUpper)) {
                return { valido: true, placa: placaUpper };
            }
            // Sugerir correcci칩n
            const letras = placaUpper.replace(/[^A-Z]/g, '').substring(0, 3).padEnd(3, 'X');
            const numeros = placaUpper.replace(/[^0-9]/g, '').substring(0, 3).padEnd(3, '0');
            const sugerencia = letras + numeros;
            return { 
                valido: false, 
                mensaje: `Formato incorrecto. Debe ser 3 letras + 3 n칰meros (ej: ABC123). 쮻esea usar: ${sugerencia}?`,
                sugerencia: sugerencia
            };
        }
        
        if (tipoVehiculo === 'Motocicleta') {
            // Formato: 3 letras + 2 n칰meros + 1 letra (ABC12D)
            const regex = /^[A-Z]{3}[0-9]{2}[A-Z]{1}$/;
            if (regex.test(placaUpper)) {
                return { valido: true, placa: placaUpper };
            }
            // Sugerir correcci칩n
            const letras = placaUpper.replace(/[^A-Z]/g, '');
            const numeros = placaUpper.replace(/[^0-9]/g, '');
            let sugerencia = letras.substring(0, 3).padEnd(3, 'X');
            sugerencia += numeros.substring(0, 2).padEnd(2, '0');
            sugerencia += letras.length > 3 ? letras[3] : (letras.length > 0 ? letras[0] : 'A');
            return { 
                valido: false, 
                mensaje: `Formato incorrecto. Debe ser 3 letras + 2 n칰meros + 1 letra (ej: ABC12D). 쮻esea usar: ${sugerencia}?`,
                sugerencia: sugerencia
            };
        }
        
        return { valido: true, placa: placaUpper };
    }

    // ---------- Ingreso ----------
    const formIngreso = document.getElementById('formIngreso');
    const msgIngreso = document.getElementById('msgIngreso');
    const inputPlacaIngreso = document.getElementById('ingresoPlaca');
    const selectTipoIngreso = document.getElementById('ingresoTipo');

    // Actualizar placeholder y hint seg칰n tipo de veh칤culo
    selectTipoIngreso.addEventListener('change', function() {
        const tipoVehiculo = this.value;
        const hintPlaca = document.getElementById('hintPlaca');
        
        if (tipoVehiculo === 'Automovil' || tipoVehiculo === 'Camion') {
            inputPlacaIngreso.placeholder = 'Ej: ABC123';
            inputPlacaIngreso.maxLength = 6;
            hintPlaca.textContent = 'Formato: 3 letras + 3 n칰meros (ej: ABC123)';
        } else if (tipoVehiculo === 'Motocicleta') {
            inputPlacaIngreso.placeholder = 'Ej: ABC12D';
            inputPlacaIngreso.maxLength = 6;
            hintPlaca.textContent = 'Formato: 3 letras + 2 n칰meros + 1 letra (ej: ABC12D)';
        } else if (tipoVehiculo === 'Bicicleta') {
            inputPlacaIngreso.placeholder = 'Ej: BICICLETA001';
            inputPlacaIngreso.maxLength = 50;
            hintPlaca.textContent = 'Cualquier texto (sin formato espec칤fico)';
            // Autocompletar con "Bicicleta " si el campo est치 vac칤o o no empieza con "Bicicleta"
            const valorActual = inputPlacaIngreso.value.trim();
            if (!valorActual || (!valorActual.toUpperCase().startsWith('BICICLETA'))) {
                inputPlacaIngreso.value = 'Bicicleta ';
                // Colocar el cursor al final
                setTimeout(() => {
                    inputPlacaIngreso.focus();
                    inputPlacaIngreso.setSelectionRange(inputPlacaIngreso.value.length, inputPlacaIngreso.value.length);
                }, 10);
            }
        } else {
            hintPlaca.textContent = '';
        }
    });

    // Validaci칩n en tiempo real de la placa
    inputPlacaIngreso.addEventListener('blur', function() {
        const tipoVehiculo = selectTipoIngreso.value;
        const placa = this.value.trim();
        
        if (placa && tipoVehiculo) {
            const validacion = validarFormatoPlaca(placa, tipoVehiculo);
            if (!validacion.valido) {
                msgIngreso.textContent = validacion.mensaje;
                msgIngreso.style.color = '#ffa500';
                
                // Si hay sugerencia de cambio de tipo de veh칤culo
                if (validacion.sugerenciaCambioTipo) {
                    const cambiarTipo = confirm(validacion.mensaje);
                    if (cambiarTipo) {
                        selectTipoIngreso.value = validacion.sugerenciaCambioTipo;
                        // Disparar el evento change para actualizar el placeholder y hint
                        selectTipoIngreso.dispatchEvent(new Event('change'));
                        msgIngreso.textContent = '';
                        msgIngreso.style.color = '';
                    }
                } else if (validacion.sugerencia) {
                    // Si hay sugerencia de correcci칩n de formato
                    const usarSugerencia = confirm(validacion.mensaje);
                    if (usarSugerencia) {
                        this.value = validacion.sugerencia;
                        msgIngreso.textContent = '';
                        msgIngreso.style.color = '';
                    }
                }
            } else {
                msgIngreso.textContent = '';
                msgIngreso.style.color = '';
            }
        }
    });

    formIngreso.addEventListener('submit', function (e) {
        e.preventDefault();
        const idParqueadero = selectParqueadero.value;
        if (!idParqueadero) {
            msgIngreso.textContent = 'Debe seleccionar un parqueadero primero.';
            msgIngreso.style.color = '#e76f51';
            return;
        }

        const tipoVehiculo = formIngreso.tipo_vehiculo.value;
        const placa = formIngreso.placa.value.trim();
        
        // Validar formato de placa
        const validacion = validarFormatoPlaca(placa, tipoVehiculo);
        if (!validacion.valido) {
            msgIngreso.textContent = validacion.mensaje;
            msgIngreso.style.color = '#e76f51';
            
            // Si hay sugerencia de cambio de tipo de veh칤culo
            if (validacion.sugerenciaCambioTipo) {
                const cambiarTipo = confirm(validacion.mensaje);
                if (cambiarTipo) {
                    selectTipoIngreso.value = validacion.sugerenciaCambioTipo;
                    // Disparar el evento change para actualizar el placeholder y hint
                    selectTipoIngreso.dispatchEvent(new Event('change'));
                    // Reintentar env칤o con el tipo corregido
                    setTimeout(() => formIngreso.dispatchEvent(new Event('submit')), 100);
                }
            } else if (validacion.sugerencia) {
                // Si hay sugerencia de correcci칩n de formato
                const usarSugerencia = confirm(validacion.mensaje);
                if (usarSugerencia) {
                    inputPlacaIngreso.value = validacion.sugerencia;
                    // Reintentar env칤o con la placa corregida
                    setTimeout(() => formIngreso.dispatchEvent(new Event('submit')), 100);
                }
            }
            return;
        }

        msgIngreso.textContent = 'Procesando ingreso...';
        msgIngreso.style.color = '';

        const datos = {
            placa: validacion.placa,
            tipo_vehiculo: tipoVehiculo,
            id_parqueadero: parseInt(idParqueadero)
        };

        fetch('/ingreso-vehiculo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(respuesta => {
            if (respuesta.success) {
                msgIngreso.innerHTML = `${respuesta.mensaje}<br><a href="${respuesta.ticketUrl}" target="_blank" class="link-action" onclick="limpiarMensajeIngreso()">游꿞 Ver Ticket</a>`;
                msgIngreso.style.color = '#56b881';
                formIngreso.reset();
                // Actualizar estad칤sticas despu칠s del ingreso
                actualizarEstadisticas(idParqueadero);
            } else {
                msgIngreso.textContent = respuesta.mensaje || 'Ocurri칩 un error en el registro.';
                msgIngreso.style.color = '#e76f51';
            }
        })
        .catch(err => {
            msgIngreso.textContent = 'Error de red o del servidor.';
            msgIngreso.style.color = '#e76f51';
        });
    });

    // ---------- Salida ----------
    const formSalida = document.getElementById('formSalida');
    const msgSalida = document.getElementById('msgSalida');
    const inputSalidaPlaca = document.getElementById('salidaPlaca');
    const inputSalidaTicket = document.getElementById('salidaTicket');
    const btnBuscarPorPlaca = document.getElementById('btnBuscarPorPlaca');
    const btnBuscarPorTicket = document.getElementById('btnBuscarPorTicket');
    const campoPlacaSalida = document.getElementById('campoPlacaSalida');
    const campoTicketSalida = document.getElementById('campoTicketSalida');
    
    let modoBusquedaSalida = 'placa'; // 'placa' o 'ticket'
    
    // Asegurar que el modo inicial est칠 correcto
    if (campoPlacaSalida && campoTicketSalida) {
        if (campoPlacaSalida.style.display !== 'none') {
            modoBusquedaSalida = 'placa';
        } else if (campoTicketSalida.style.display !== 'none') {
            modoBusquedaSalida = 'ticket';
        }
    }

    // Intercambiador de modo de b칰squeda
    btnBuscarPorPlaca.addEventListener('click', function() {
        modoBusquedaSalida = 'placa';
        campoPlacaSalida.style.display = 'block';
        campoTicketSalida.style.display = 'none';
        inputSalidaPlaca.value = '';
        inputSalidaTicket.value = '';
        btnBuscarPorPlaca.style.background = 'var(--color-botones-sec)';
        btnBuscarPorPlaca.style.color = 'white';
        btnBuscarPorTicket.style.background = 'var(--color-fondo-claro)';
        btnBuscarPorTicket.style.color = 'var(--color-principal)';
        msgSalida.textContent = '';
    });

    btnBuscarPorTicket.addEventListener('click', function() {
        modoBusquedaSalida = 'ticket';
        campoPlacaSalida.style.display = 'none';
        campoTicketSalida.style.display = 'block';
        inputSalidaPlaca.value = '';
        inputSalidaTicket.value = '';
        btnBuscarPorTicket.style.background = 'var(--color-botones-sec)';
        btnBuscarPorTicket.style.color = 'white';
        btnBuscarPorPlaca.style.background = 'var(--color-fondo-claro)';
        btnBuscarPorPlaca.style.color = 'var(--color-principal)';
        msgSalida.textContent = '';
    });

    formSalida.addEventListener('submit', function (e) {
        e.preventDefault();
        const idParqueadero = selectParqueadero.value;
        if (!idParqueadero) {
            msgSalida.textContent = 'Debe seleccionar un parqueadero primero.';
            msgSalida.style.color = '#e76f51';
            return;
        }

        // Determinar el modo actual basado en qu칠 campo est치 visible
        const modoActual = campoPlacaSalida.style.display !== 'none' ? 'placa' : 'ticket';

        let datos = {
            id_parqueadero: parseInt(idParqueadero)
        };

        // Validar seg칰n el modo de b칰squeda actual
        if (modoActual === 'ticket') {
            let numeroTicket = inputSalidaTicket.value.trim();
            // Remover el s칤mbolo # si est치 presente
            numeroTicket = numeroTicket.replace(/^#/, '');
            if (!numeroTicket || isNaN(numeroTicket) || parseInt(numeroTicket) <= 0) {
                msgSalida.textContent = 'Debe ingresar un n칰mero de ticket v치lido.';
                msgSalida.style.color = '#e76f51';
                return;
            }
            datos.id_ticket = parseInt(numeroTicket);
            // Asegurar que no se env칤e placa cuando se busca por ticket
            delete datos.placa;
        } else {
            const placa = inputSalidaPlaca.value.trim();
            if (!placa) {
                msgSalida.textContent = 'Debe ingresar la placa del veh칤culo.';
                msgSalida.style.color = '#e76f51';
                return;
            }
            datos.placa = placa.toUpperCase();
            // Asegurar que no se env칤e id_ticket cuando se busca por placa
            delete datos.id_ticket;
        }

        msgSalida.textContent = 'Procesando salida...';
        msgSalida.style.color = '';

        fetch('/salida-vehiculo', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(respuesta => {
            if (respuesta.success) {
                msgSalida.innerHTML = `<b>Factura generada</b>:<br>Valor a pagar: <span style='color:#3d5a80;font-size:1.3em'>${respuesta.valor_pagar}</span> <br>${respuesta.mensaje || ''}<br><a href="${respuesta.facturaUrl}" target="_blank" class="link-action" onclick="limpiarMensajeSalida()">游 Ver Factura</a>`;
                msgSalida.style.color = '#56b881';
                // Limpiar campos seg칰n el modo actual
                if (modoBusquedaSalida === 'ticket') {
                    inputSalidaTicket.value = '';
                } else {
                    inputSalidaPlaca.value = '';
                }
                // Actualizar estad칤sticas despu칠s de la salida
                actualizarEstadisticas(idParqueadero);
            } else {
                msgSalida.textContent = respuesta.mensaje || 'Error procesando salida.';
                msgSalida.style.color = '#e76f51';
            }
        })
        .catch(err => {
            msgSalida.textContent = 'Error de red o del servidor.';
            msgSalida.style.color = '#e76f51';
        });
    });

    // ---------- Cargar Veh칤culos Ingresados ----------
    function cargarVehiculosIngresados() {
        const vehiculosLista = document.getElementById('vehiculosLista');
        vehiculosLista.innerHTML = '<div class="loading-vehiculos">Cargando veh칤culos...</div>';

        fetch('/vehiculos-ingresados')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarVehiculos(data.vehiculos);
                } else {
                    vehiculosLista.innerHTML = '<div class="no-vehiculos">No se pudieron cargar los veh칤culos.</div>';
                }
            })
            .catch(err => {
                console.error('Error cargando veh칤culos:', err);
                vehiculosLista.innerHTML = '<div class="no-vehiculos">Error al cargar los veh칤culos.</div>';
            });
    }

    function mostrarVehiculos(vehiculos) {
        const vehiculosLista = document.getElementById('vehiculosLista');
        
        if (vehiculos.length === 0) {
            vehiculosLista.innerHTML = '<div class="no-vehiculos">No hay veh칤culos ingresados en este momento.</div>';
            return;
        }

        vehiculosLista.innerHTML = `
            <table class="tabla-vehiculos">
                <thead>
                    <tr>
                        <th>Placa</th>
                        <th>Tipo</th>
                        <th>Marca/Modelo</th>
                        <th>Color</th>
                        <th>Parqueadero</th>
                        <th>Hora Ingreso</th>
                        <th>Tiempo Estacionado</th>
                        <th>Ticket</th>
                    </tr>
                </thead>
                <tbody>
                    ${vehiculos.map(vehiculo => {
                        const horaEntrada = new Date(vehiculo.hora_entrada);
                        const minutosEstacionado = vehiculo.minutos_estacionado || 0;
                        const horas = Math.floor(minutosEstacionado / 60);
                        const minutos = minutosEstacionado % 60;
                        const tiempoTexto = horas > 0 ? `${horas}h ${minutos}m` : `${minutos}m`;
                        
                        return `
                            <tr>
                                <td><strong>${vehiculo.placa}</strong></td>
                                <td>${vehiculo.tipo_vehiculo || '-'}</td>
                                <td>${(vehiculo.marca || '') + ' ' + (vehiculo.modelo || '') || '-'}</td>
                                <td>${vehiculo.color || '-'}</td>
                                <td>${vehiculo.nombre_parqueadero || 'No asignado'}</td>
                                <td>${horaEntrada.toLocaleTimeString()}</td>
                                <td>${tiempoTexto}</td>
                                <td>#${vehiculo.id_ticket}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    // Bot칩n actualizar veh칤culos
    const btnActualizarVehiculos = document.getElementById('btnActualizarVehiculos');
    if (btnActualizarVehiculos) {
        btnActualizarVehiculos.addEventListener('click', function() {
            cargarVehiculosIngresados();
        });
    }

    // ---------- Gesti칩n de Parqueaderos ----------
    const formParqueadero = document.getElementById('formParqueadero');
    const msgRegistro = document.getElementById('msgRegistro');
    const btnGuardarParqueadero = document.getElementById('btnGuardarParqueadero');
    const btnCancelarEdicion = document.getElementById('btnCancelarEdicion');
    const tituloFormParqueadero = document.getElementById('tituloFormParqueadero');

    function resetearFormulario() {
        formParqueadero.reset();
        document.getElementById('idParqueaderoEdit').value = '';
        btnGuardarParqueadero.textContent = 'Registrar Parqueadero';
        tituloFormParqueadero.textContent = 'Registro de Parqueadero';
        btnCancelarEdicion.style.display = 'none';
        document.getElementById('idParqueadero').disabled = false;
    }

    function cargarDatosEnFormulario(parqueadero) {
        document.getElementById('idParqueaderoEdit').value = parqueadero.id_parqueadero;
        document.getElementById('idParqueadero').value = parqueadero.id_parqueadero;
        document.getElementById('idParqueadero').disabled = true;
        document.getElementById('nombreParqueadero').value = parqueadero.nombre || '';
        document.getElementById('horario').value = parqueadero.horario || '';
        document.getElementById('capacidad').value = parqueadero.capacidad_total || '';
        document.getElementById('ubicacion').value = parqueadero.direccion || '';
        document.getElementById('tipo').value = parqueadero.tipo_parqueadero || 'Publico';
        btnGuardarParqueadero.textContent = 'Modificar Parqueadero';
        tituloFormParqueadero.textContent = 'Modificar Parqueadero';
        btnCancelarEdicion.style.display = 'inline-block';
    }

    btnCancelarEdicion.addEventListener('click', function() {
        resetearFormulario();
    });

    formParqueadero.addEventListener('submit', function (e) {
        e.preventDefault();
        msgRegistro.textContent = 'Procesando...';
        msgRegistro.style.color = '';

        const idEdit = document.getElementById('idParqueaderoEdit').value;
        const idValue = document.getElementById('idParqueadero').value.trim();
        const datos = {
            id: idValue || null,
            nombre: document.getElementById('nombreParqueadero').value.trim(),
            horario: document.getElementById('horario').value.trim(),
            capacidad: parseInt(document.getElementById('capacidad').value.trim(), 10),
            direccion: document.getElementById('ubicacion').value.trim(),
            tipo: document.getElementById('tipo').value,
            idEdit: idEdit || null
        };

        fetch('/registrar-parqueadero', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(respuesta => {
            if (respuesta.success) {
                msgRegistro.textContent = respuesta.mensaje || 'Operaci칩n realizada correctamente.';
                msgRegistro.style.color = '#56b881';
                resetearFormulario();
                cargarListaParqueaderos();
                // Limpiar mensaje despu칠s de 3 segundos
                setTimeout(() => {
                    msgRegistro.textContent = '';
                    msgRegistro.style.color = '';
                }, 3000);
            } else {
                msgRegistro.textContent = respuesta.mensaje || 'Error en la operaci칩n.';
                msgRegistro.style.color = '#e76f51';
            }
        })
        .catch(() => {
            msgRegistro.textContent = 'Error de red o servidor.';
            msgRegistro.style.color = '#e76f51';
        });
    });

    function cargarListaParqueaderos() {
        const listaParqueaderos = document.getElementById('listaParqueaderos');
        listaParqueaderos.innerHTML = '<div class="loading-vehiculos">Cargando parqueaderos...</div>';

        fetch('/obtener-parqueaderos')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarListaParqueaderos(data.parqueaderos);
                } else {
                    listaParqueaderos.innerHTML = '<div class="no-vehiculos">No se pudieron cargar los parqueaderos.</div>';
                }
            })
            .catch(err => {
                console.error('Error cargando parqueaderos:', err);
                listaParqueaderos.innerHTML = '<div class="no-vehiculos">Error al cargar los parqueaderos.</div>';
            });
    }

    function mostrarListaParqueaderos(parqueaderos) {
        const listaParqueaderos = document.getElementById('listaParqueaderos');
        
        if (parqueaderos.length === 0) {
            listaParqueaderos.innerHTML = '<div class="no-vehiculos">No hay parqueaderos registrados.</div>';
            return;
        }

        listaParqueaderos.innerHTML = `
            <table class="tabla-vehiculos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Direcci칩n</th>
                        <th>Horario</th>
                        <th>Capacidad</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${parqueaderos.map(p => {
                        const estado = p.estado || 'Activo';
                        const estadoClass = estado === 'Activo' ? 'estado-activo' : 'estado-inactivo';
                        return `
                            <tr>
                                <td><strong>${p.id_parqueadero}</strong></td>
                                <td>${p.nombre}</td>
                                <td>${p.direccion}</td>
                                <td>${p.horario || '-'}</td>
                                <td>${p.capacidad_total || 0}</td>
                                <td>${p.tipo_parqueadero || '-'}</td>
                                <td><span class="${estadoClass}">${estado}</span></td>
                                <td>
                                    <button class="btn-accion btn-editar" onclick="editarParqueadero(${p.id_parqueadero})">九勇 Editar</button>
                                    ${estado === 'Activo' 
                                        ? `<button class="btn-accion btn-inhabilitar" onclick="inhabilitarParqueadero(${p.id_parqueadero})">游뛂 Inhabilitar</button>`
                                        : `<button class="btn-accion btn-habilitar" onclick="habilitarParqueadero(${p.id_parqueadero})">九 Habilitar</button>`
                                    }
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    // Funciones globales para los botones de acci칩n
    window.editarParqueadero = function(id) {
        fetch(`/obtener-parqueadero/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    cargarDatosEnFormulario(data.parqueadero);
                    // Scroll al formulario
                    document.getElementById('formParqueadero').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            })
            .catch(err => {
                console.error('Error cargando parqueadero:', err);
                alert('Error al cargar los datos del parqueadero.');
            });
    };

    window.inhabilitarParqueadero = function(id) {
        if (confirm('쮼st치 seguro de que desea inhabilitar este parqueadero?')) {
            fetch('/cambiar-estado-parqueadero', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_parqueadero: id, estado: 'Inactivo' })
            })
            .then(res => res.json())
            .then(respuesta => {
                if (respuesta.success) {
                    cargarListaParqueaderos();
                    cargarParqueaderos(); // Actualizar selector en ingreso/salida
                } else {
                    alert(respuesta.mensaje || 'Error al inhabilitar el parqueadero.');
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al inhabilitar el parqueadero.');
            });
        }
    };

    window.habilitarParqueadero = function(id) {
        fetch('/cambiar-estado-parqueadero', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_parqueadero: id, estado: 'Activo' })
        })
        .then(res => res.json())
        .then(respuesta => {
            if (respuesta.success) {
                cargarListaParqueaderos();
                cargarParqueaderos(); // Actualizar selector en ingreso/salida
            } else {
                alert(respuesta.mensaje || 'Error al habilitar el parqueadero.');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error al habilitar el parqueadero.');
        });
    };

    // Bot칩n actualizar parqueaderos
    const btnActualizarParqueaderos = document.getElementById('btnActualizarParqueaderos');
    if (btnActualizarParqueaderos) {
        btnActualizarParqueaderos.addEventListener('click', function() {
            cargarListaParqueaderos();
        });
    }

    // ---------- Estad칤sticas de Espacios Ocupados ----------
    function cargarEstadisticasEspacios() {
        const estadisticasEspacios = document.getElementById('estadisticasEspacios');
        estadisticasEspacios.innerHTML = '<div class="loading-vehiculos">Cargando estad칤sticas...</div>';

        fetch('/estadisticas-espacios-ocupados')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarEstadisticasEspacios(data.estadisticas);
                } else {
                    estadisticasEspacios.innerHTML = '<div class="no-vehiculos">No se pudieron cargar las estad칤sticas.</div>';
                }
            })
            .catch(err => {
                console.error('Error cargando estad칤sticas:', err);
                estadisticasEspacios.innerHTML = '<div class="no-vehiculos">Error al cargar las estad칤sticas.</div>';
            });
    }

    function mostrarEstadisticasEspacios(estadisticas) {
        const estadisticasEspacios = document.getElementById('estadisticasEspacios');
        
        if (estadisticas.length === 0) {
            estadisticasEspacios.innerHTML = '<div class="no-vehiculos">No hay parqueaderos activos.</div>';
            return;
        }

        estadisticasEspacios.innerHTML = estadisticas.map(est => {
            const porcentajeColor = est.porcentaje_ocupacion >= 90 ? 'var(--color-error)' : 
                                   est.porcentaje_ocupacion >= 70 ? '#ffa500' : 
                                   'var(--color-exito)';
            
            return `
                <div class="estadistica-parqueadero">
                    <div class="estadistica-header">
                        <div>
                            <h4 class="estadistica-nombre">${est.nombre}</h4>
                            <p class="estadistica-direccion">${est.direccion}</p>
                        </div>
                        <div class="estadistica-ocupacion">
                            <div class="ocupacion-porcentaje" style="color: ${porcentajeColor}">
                                ${est.porcentaje_ocupacion}%
                            </div>
                            <div class="ocupacion-label">Ocupaci칩n</div>
                        </div>
                    </div>
                    
                    <div class="estadistica-resumen">
                        <div class="resumen-item">
                            <div class="resumen-label">Total Ocupados</div>
                            <div class="resumen-valor resumen-ocupados">${est.total_ocupados}</div>
                        </div>
                        <div class="resumen-item">
                            <div class="resumen-label">Disponibles</div>
                            <div class="resumen-valor resumen-disponibles">${est.disponibles}</div>
                        </div>
                        <div class="resumen-item">
                            <div class="resumen-label">Capacidad Total</div>
                            <div class="resumen-valor resumen-capacidad">${est.capacidad_total}</div>
                        </div>
                    </div>

                    <div class="estadistica-tipos">
                        <h5 class="tipos-titulo">Distribuci칩n por Tipo de Veh칤culo</h5>
                        <div class="tipos-grid">
                            <div class="tipo-item ${est.por_tipo.Automovil > 0 ? 'tipo-activo' : ''}">
                                <div class="tipo-icono">游뚱</div>
                                <div class="tipo-nombre">Autom칩vil</div>
                                <div class="tipo-cantidad">${est.por_tipo.Automovil}</div>
                            </div>
                            <div class="tipo-item ${est.por_tipo.Motocicleta > 0 ? 'tipo-activo' : ''}">
                                <div class="tipo-icono">游끬勇</div>
                                <div class="tipo-nombre">Motocicleta</div>
                                <div class="tipo-cantidad">${est.por_tipo.Motocicleta}</div>
                            </div>
                            <div class="tipo-item ${est.por_tipo.Camion > 0 ? 'tipo-activo' : ''}">
                                <div class="tipo-icono">游뚴</div>
                                <div class="tipo-nombre">Cami칩n</div>
                                <div class="tipo-cantidad">${est.por_tipo.Camion}</div>
                            </div>
                            <div class="tipo-item ${est.por_tipo.Bicicleta > 0 ? 'tipo-activo' : ''}">
                                <div class="tipo-icono">游</div>
                                <div class="tipo-nombre">Bicicleta</div>
                                <div class="tipo-cantidad">${est.por_tipo.Bicicleta}</div>
                            </div>
                        </div>
                    </div>

                    <div class="estadistica-barra">
                        <div class="barra-fondo">
                            <div class="barra-progreso" style="width: ${est.porcentaje_ocupacion}%; background-color: ${porcentajeColor}"></div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Bot칩n actualizar espacios
    const btnActualizarEspacios = document.getElementById('btnActualizarEspacios');
    if (btnActualizarEspacios) {
        btnActualizarEspacios.addEventListener('click', function() {
            cargarEstadisticasEspacios();
        });
    }

    // ---------- Gesti칩n de Tarifas ----------
    const formTarifa = document.getElementById('formTarifa');
    const msgTarifa = document.getElementById('msgTarifa');
    const btnGuardarTarifa = document.getElementById('btnGuardarTarifa');
    const btnCancelarEdicionTarifa = document.getElementById('btnCancelarEdicionTarifa');
    const tituloFormTarifa = document.getElementById('tituloFormTarifa');

    function resetearFormularioTarifa() {
        formTarifa.reset();
        document.getElementById('idTarifaEdit').value = '';
        btnGuardarTarifa.textContent = 'Registrar Tarifa';
        tituloFormTarifa.textContent = 'Registro de Tarifa';
        btnCancelarEdicionTarifa.style.display = 'none';
    }

    function cargarDatosEnFormularioTarifa(tarifa) {
        document.getElementById('idTarifaEdit').value = tarifa.id_tarifa;
        document.getElementById('tipoTarifa').value = tarifa.tipo_tarifa || '';
        document.getElementById('tipoVehiculoTarifa').value = tarifa.tipo_vehiculo || '';
        document.getElementById('valorUnitario').value = tarifa.valor_unitario || '';
        btnGuardarTarifa.textContent = 'Modificar Tarifa';
        tituloFormTarifa.textContent = 'Modificar Tarifa';
        btnCancelarEdicionTarifa.style.display = 'inline-block';
    }

    btnCancelarEdicionTarifa.addEventListener('click', function() {
        resetearFormularioTarifa();
    });

    formTarifa.addEventListener('submit', function (e) {
        e.preventDefault();
        msgTarifa.textContent = 'Procesando...';
        msgTarifa.style.color = '';

        const idEdit = document.getElementById('idTarifaEdit').value;
        const datos = {
            tipo_tarifa: document.getElementById('tipoTarifa').value.trim(),
            tipo_vehiculo: document.getElementById('tipoVehiculoTarifa').value,
            valor_unitario: parseFloat(document.getElementById('valorUnitario').value.trim()),
            idEdit: idEdit || null
        };

        fetch('/registrar-tarifa', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(respuesta => {
            if (respuesta.success) {
                msgTarifa.textContent = respuesta.mensaje || 'Operaci칩n realizada correctamente.';
                msgTarifa.style.color = '#56b881';
                resetearFormularioTarifa();
                cargarListaTarifas();
                // Limpiar mensaje despu칠s de 3 segundos
                setTimeout(() => {
                    msgTarifa.textContent = '';
                    msgTarifa.style.color = '';
                }, 3000);
            } else {
                msgTarifa.textContent = respuesta.mensaje || 'Error en la operaci칩n.';
                msgTarifa.style.color = '#e76f51';
            }
        })
        .catch(() => {
            msgTarifa.textContent = 'Error de red o servidor.';
            msgTarifa.style.color = '#e76f51';
        });
    });

    function cargarListaTarifas() {
        const listaTarifas = document.getElementById('listaTarifas');
        listaTarifas.innerHTML = '<div class="loading-vehiculos">Cargando tarifas...</div>';

        fetch('/obtener-tarifas')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarListaTarifas(data.tarifas);
                } else {
                    listaTarifas.innerHTML = '<div class="no-vehiculos">No se pudieron cargar las tarifas.</div>';
                }
            })
            .catch(err => {
                console.error('Error cargando tarifas:', err);
                listaTarifas.innerHTML = '<div class="no-vehiculos">Error al cargar las tarifas.</div>';
            });
    }

    function mostrarListaTarifas(tarifas) {
        const listaTarifas = document.getElementById('listaTarifas');
        
        if (tarifas.length === 0) {
            listaTarifas.innerHTML = '<div class="no-vehiculos">No hay tarifas registradas.</div>';
            return;
        }

        listaTarifas.innerHTML = `
            <table class="tabla-vehiculos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tipo de Tarifa</th>
                        <th>Tipo de Veh칤culo</th>
                        <th>Valor Unitario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${tarifas.map(t => {
                        const tipoVehiculoNombre = {
                            'Automovil': 'Autom칩vil',
                            'Motocicleta': 'Motocicleta',
                            'Camion': 'Cami칩n',
                            'Bicicleta': 'Bicicleta'
                        }[t.tipo_vehiculo] || t.tipo_vehiculo || '-';
                        
                        return `
                            <tr>
                                <td><strong>${t.id_tarifa}</strong></td>
                                <td>${t.tipo_tarifa || '-'}</td>
                                <td>${tipoVehiculoNombre}</td>
                                <td>$${parseFloat(t.valor_unitario || 0).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td>
                                    <button class="btn-accion btn-editar" onclick="editarTarifa(${t.id_tarifa})">九勇 Editar</button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    // Funciones globales para los botones de acci칩n
    window.editarTarifa = function(id) {
        fetch(`/obtener-tarifa/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    cargarDatosEnFormularioTarifa(data.tarifa);
                    // Scroll al formulario
                    document.getElementById('formTarifa').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            })
            .catch(err => {
                console.error('Error cargando tarifa:', err);
                alert('Error al cargar los datos de la tarifa.');
            });
    };

    // Bot칩n actualizar tarifas
    const btnActualizarTarifas = document.getElementById('btnActualizarTarifas');
    if (btnActualizarTarifas) {
        btnActualizarTarifas.addEventListener('click', function() {
            cargarListaTarifas();
        });
    }

    // ---------- GESTI칍N DE PROVEEDORES ----------
    const formProveedor = document.getElementById('formProveedor');
    const msgProveedor = document.getElementById('msgProveedor');
    const btnGuardarProveedor = document.getElementById('btnGuardarProveedor');
    const tituloFormProveedor = document.getElementById('tituloFormProveedor');
    const btnCancelarEdicionProveedor = document.getElementById('btnCancelarEdicionProveedor');

    function resetearFormularioProveedor() {
        formProveedor.reset();
        document.getElementById('idProveedorEdit').value = '';
        btnGuardarProveedor.textContent = 'Registrar Proveedor';
        tituloFormProveedor.textContent = 'Registro de Proveedor';
        btnCancelarEdicionProveedor.style.display = 'none';
    }

    function cargarDatosEnFormularioProveedor(proveedor) {
        document.getElementById('idProveedorEdit').value = proveedor.id_proveedor;
        document.getElementById('nombreProveedor').value = proveedor.nombre_proveedor || '';
        document.getElementById('tipoServicioProveedor').value = proveedor.tipo_servicio || '';
        document.getElementById('telefonoProveedor').value = proveedor.telefono || '';
        document.getElementById('emailProveedor').value = proveedor.email || '';
        document.getElementById('parqueaderoProveedor').value = proveedor.id_parqueadero || '';
        btnGuardarProveedor.textContent = 'Modificar Proveedor';
        tituloFormProveedor.textContent = 'Modificar Proveedor';
        btnCancelarEdicionProveedor.style.display = 'inline-block';
    }

    function cargarParqueaderosParaProveedores() {
        const selectParqueadero = document.getElementById('parqueaderoProveedor');
        fetch('/obtener-parqueaderos-activos')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const currentValue = selectParqueadero.value;
                    selectParqueadero.innerHTML = '<option value="">-- Seleccione un parqueadero --</option>';
                    data.parqueaderos.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id_parqueadero;
                        option.textContent = p.nombre;
                        selectParqueadero.appendChild(option);
                    });
                    if (currentValue) {
                        selectParqueadero.value = currentValue;
                    }
                }
            })
            .catch(err => console.error('Error cargando parqueaderos:', err));
    }

    btnCancelarEdicionProveedor.addEventListener('click', function() {
        resetearFormularioProveedor();
    });

    formProveedor.addEventListener('submit', function (e) {
        e.preventDefault();
        msgProveedor.textContent = 'Procesando...';
        msgProveedor.style.color = '';

        const idEdit = document.getElementById('idProveedorEdit').value;
        const datos = {
            nombre_proveedor: document.getElementById('nombreProveedor').value.trim(),
            tipo_servicio: document.getElementById('tipoServicioProveedor').value.trim() || null,
            telefono: document.getElementById('telefonoProveedor').value.trim() || null,
            email: document.getElementById('emailProveedor').value.trim() || null,
            id_parqueadero: parseInt(document.getElementById('parqueaderoProveedor').value),
            idEdit: idEdit || null
        };

        fetch('/registrar-proveedor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(respuesta => {
            if (respuesta.success) {
                msgProveedor.textContent = respuesta.mensaje || 'Operaci칩n realizada correctamente.';
                msgProveedor.style.color = '#56b881';
                resetearFormularioProveedor();
                cargarListaProveedores();
                setTimeout(() => {
                    msgProveedor.textContent = '';
                    msgProveedor.style.color = '';
                }, 3000);
            } else {
                msgProveedor.textContent = respuesta.mensaje || 'Error en la operaci칩n.';
                msgProveedor.style.color = '#e76f51';
            }
        })
        .catch(() => {
            msgProveedor.textContent = 'Error de red o servidor.';
            msgProveedor.style.color = '#e76f51';
        });
    });

    function cargarListaProveedores() {
        const listaProveedores = document.getElementById('listaProveedores');
        listaProveedores.innerHTML = '<div class="loading-vehiculos">Cargando proveedores...</div>';

        fetch('/obtener-proveedores')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarListaProveedores(data.proveedores);
                } else {
                    listaProveedores.innerHTML = '<div class="no-vehiculos">No se pudieron cargar los proveedores.</div>';
                }
            })
            .catch(err => {
                console.error('Error cargando proveedores:', err);
                listaProveedores.innerHTML = '<div class="no-vehiculos">Error al cargar los proveedores.</div>';
            });
    }

    function mostrarListaProveedores(proveedores) {
        const listaProveedores = document.getElementById('listaProveedores');
        
        if (proveedores.length === 0) {
            listaProveedores.innerHTML = '<div class="no-vehiculos">No hay proveedores registrados.</div>';
            return;
        }

        listaProveedores.innerHTML = `
            <table class="tabla-vehiculos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Tipo de Servicio</th>
                        <th>Tel칠fono</th>
                        <th>Email</th>
                        <th>Parqueadero</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${proveedores.map(p => `
                        <tr>
                            <td><strong>${p.id_proveedor}</strong></td>
                            <td>${p.nombre_proveedor || '-'}</td>
                            <td>${p.tipo_servicio || '-'}</td>
                            <td>${p.telefono || '-'}</td>
                            <td>${p.email || '-'}</td>
                            <td>${p.nombre_parqueadero || '-'}</td>
                            <td>
                                <button class="btn-accion btn-editar" onclick="editarProveedor(${p.id_proveedor})">九勇 Editar</button>
                                <button class="btn-accion btn-inhabilitar" onclick="eliminarProveedor(${p.id_proveedor})">游딈勇 Eliminar</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    window.editarProveedor = function(id) {
        fetch(`/obtener-proveedor/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    cargarDatosEnFormularioProveedor(data.proveedor);
                    document.getElementById('formProveedor').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            })
            .catch(err => {
                console.error('Error cargando proveedor:', err);
                alert('Error al cargar los datos del proveedor.');
            });
    };

    window.eliminarProveedor = function(id) {
        if (!confirm('쮼st치 seguro de eliminar este proveedor? Esta acci칩n no se puede deshacer.')) {
            return;
        }
        fetch('/eliminar-proveedor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_proveedor: id })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                cargarListaProveedores();
                alert(data.mensaje || 'Proveedor eliminado correctamente.');
            } else {
                alert(data.mensaje || 'Error al eliminar el proveedor.');
            }
        })
        .catch(err => {
            console.error('Error eliminando proveedor:', err);
            alert('Error al eliminar el proveedor.');
        });
    };

    const btnActualizarProveedores = document.getElementById('btnActualizarProveedores');
    if (btnActualizarProveedores) {
        btnActualizarProveedores.addEventListener('click', function() {
            cargarListaProveedores();
        });
    }

    // ---------- GESTI칍N DE SERVICIOS PROGRAMADOS ----------
    const formServicio = document.getElementById('formServicio');
    const msgServicio = document.getElementById('msgServicio');
    const btnGuardarServicio = document.getElementById('btnGuardarServicio');
    const tituloFormServicio = document.getElementById('tituloFormServicio');
    const btnCancelarEdicionServicio = document.getElementById('btnCancelarEdicionServicio');

    function resetearFormularioServicio() {
        formServicio.reset();
        document.getElementById('idServicioEdit').value = '';
        document.getElementById('estadoServicio').value = 'Programado';
        btnGuardarServicio.textContent = 'Registrar Servicio';
        tituloFormServicio.textContent = 'Registro de Servicio Programado';
        btnCancelarEdicionServicio.style.display = 'none';
    }

    function cargarDatosEnFormularioServicio(servicio) {
        document.getElementById('idServicioEdit').value = servicio.id_servicio_programado;
        document.getElementById('proveedorServicio').value = servicio.id_proveedor || '';
        document.getElementById('fechaProgramada').value = servicio.fecha_programada || '';
        document.getElementById('horaProgramada').value = servicio.hora_programada || '';
        document.getElementById('estadoServicio').value = servicio.estado || 'Programado';
        document.getElementById('descripcionServicio').value = servicio.descripcion_servicio || '';
        document.getElementById('observacionesServicio').value = servicio.observaciones || '';
        btnGuardarServicio.textContent = 'Modificar Servicio';
        tituloFormServicio.textContent = 'Modificar Servicio Programado';
        btnCancelarEdicionServicio.style.display = 'inline-block';
    }

    function cargarProveedoresParaServicios() {
        const selectProveedor = document.getElementById('proveedorServicio');
        const filtroProveedor = document.getElementById('filtroProveedorServicio');
        fetch('/obtener-proveedores')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const currentValue = selectProveedor.value;
                    const currentFiltroValue = filtroProveedor.value;
                    selectProveedor.innerHTML = '<option value="">-- Seleccione un proveedor --</option>';
                    filtroProveedor.innerHTML = '<option value="">Todos los proveedores</option>';
                    data.proveedores.forEach(p => {
                        const option1 = document.createElement('option');
                        option1.value = p.id_proveedor;
                        option1.textContent = p.nombre_proveedor;
                        selectProveedor.appendChild(option1);
                        const option2 = document.createElement('option');
                        option2.value = p.id_proveedor;
                        option2.textContent = p.nombre_proveedor;
                        filtroProveedor.appendChild(option2);
                    });
                    if (currentValue) selectProveedor.value = currentValue;
                    if (currentFiltroValue) filtroProveedor.value = currentFiltroValue;
                }
            })
            .catch(err => console.error('Error cargando proveedores:', err));
    }

    btnCancelarEdicionServicio.addEventListener('click', function() {
        resetearFormularioServicio();
    });

    formServicio.addEventListener('submit', function (e) {
        e.preventDefault();
        msgServicio.textContent = 'Procesando...';
        msgServicio.style.color = '';

        const idEdit = document.getElementById('idServicioEdit').value;
        const datos = {
            id_proveedor: parseInt(document.getElementById('proveedorServicio').value),
            descripcion_servicio: document.getElementById('descripcionServicio').value.trim(),
            fecha_programada: document.getElementById('fechaProgramada').value,
            hora_programada: document.getElementById('horaProgramada').value,
            estado: document.getElementById('estadoServicio').value,
            observaciones: document.getElementById('observacionesServicio').value.trim() || null,
            idEdit: idEdit || null
        };

        fetch('/registrar-servicio-programado', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(respuesta => {
            if (respuesta.success) {
                msgServicio.textContent = respuesta.mensaje || 'Operaci칩n realizada correctamente.';
                msgServicio.style.color = '#56b881';
                // Si se modific칩 un servicio, actualizar el filtro al estado del servicio modificado
                if (idEdit) {
                    const estadoModificado = document.getElementById('estadoServicio').value;
                    document.getElementById('filtroEstadoServicio').value = estadoModificado;
                }
                resetearFormularioServicio();
                cargarListaServicios();
                setTimeout(() => {
                    msgServicio.textContent = '';
                    msgServicio.style.color = '';
                }, 3000);
            } else {
                msgServicio.textContent = respuesta.mensaje || 'Error en la operaci칩n.';
                msgServicio.style.color = '#e76f51';
            }
        })
        .catch(() => {
            msgServicio.textContent = 'Error de red o servidor.';
            msgServicio.style.color = '#e76f51';
        });
    });

    function cargarListaServicios() {
        const listaServicios = document.getElementById('listaServicios');
        listaServicios.innerHTML = '<div class="loading-vehiculos">Cargando servicios programados...</div>';

        const estado = document.getElementById('filtroEstadoServicio').value;
        const idProveedor = document.getElementById('filtroProveedorServicio').value;
        const fechaInicio = document.getElementById('filtroFechaInicio').value;
        const fechaFin = document.getElementById('filtroFechaFin').value;

        const params = new URLSearchParams();
        // Si el estado est치 vac칤o, no enviar el par치metro (mostrar치 solo activos por defecto)
        // Si el estado tiene un valor, enviarlo para filtrar
        if (estado && estado.trim() !== '') {
            params.append('estado', estado);
        }
        if (idProveedor && idProveedor.trim() !== '') {
            params.append('idProveedor', idProveedor);
        }
        if (fechaInicio && fechaInicio.trim() !== '') {
            params.append('fechaInicio', fechaInicio);
        }
        if (fechaFin && fechaFin.trim() !== '') {
            params.append('fechaFin', fechaFin);
        }

        const url = '/obtener-servicios-programados?' + params.toString();

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarListaServicios(data.servicios);
                } else {
                    listaServicios.innerHTML = '<div class="no-vehiculos">No se pudieron cargar los servicios programados.</div>';
                }
            })
            .catch(err => {
                console.error('Error cargando servicios:', err);
                listaServicios.innerHTML = '<div class="no-vehiculos">Error al cargar los servicios programados.</div>';
            });
    }

    function mostrarListaServicios(servicios) {
        const listaServicios = document.getElementById('listaServicios');
        
        if (servicios.length === 0) {
            listaServicios.innerHTML = '<div class="no-vehiculos">No hay servicios programados.</div>';
            return;
        }

        const estadoClass = {
            'Programado': 'estado-pendiente',
            'En Proceso': 'estado-activo',
            'Completado': 'estado-pagado',
            'Cancelado': 'estado-inactivo'
        };

        listaServicios.innerHTML = `
            <table class="tabla-vehiculos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Proveedor</th>
                        <th>Descripci칩n</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Parqueadero</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${servicios.map(s => {
                        const fecha = new Date(s.fecha_programada);
                        const fechaFormateada = fecha.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        const horaFormateada = s.hora_programada ? s.hora_programada.substring(0, 5) : '-';
                        return `
                            <tr>
                                <td><strong>${s.id_servicio_programado}</strong></td>
                                <td>${s.nombre_proveedor || '-'}</td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${s.descripcion_servicio || ''}">${s.descripcion_servicio || '-'}</td>
                                <td>${fechaFormateada}</td>
                                <td>${horaFormateada}</td>
                                <td>${s.nombre_parqueadero || '-'}</td>
                                <td><span class="${estadoClass[s.estado] || ''}">${s.estado || '-'}</span></td>
                                <td>
                                    <button class="btn-accion btn-editar" onclick="editarServicio(${s.id_servicio_programado})">九勇 Editar</button>
                                    ${s.estado !== 'Completado' && s.estado !== 'Cancelado' ? `
                                        <button class="btn-accion btn-habilitar" onclick="cambiarEstadoServicio(${s.id_servicio_programado}, 'Completado')">九 Completar</button>
                                        <button class="btn-accion btn-inhabilitar" onclick="cambiarEstadoServicio(${s.id_servicio_programado}, 'Cancelado')">仇 Cancelar</button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    window.editarServicio = function(id) {
        fetch(`/obtener-servicio-programado/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    cargarDatosEnFormularioServicio(data.servicio);
                    document.getElementById('formServicio').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            })
            .catch(err => {
                console.error('Error cargando servicio:', err);
                alert('Error al cargar los datos del servicio.');
            });
    };

    window.cambiarEstadoServicio = function(id, estado) {
        fetch('/cambiar-estado-servicio-programado', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_servicio_programado: id, estado: estado })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Establecer el filtro al nuevo estado para que el usuario vea el servicio actualizado
                document.getElementById('filtroEstadoServicio').value = estado;
                cargarListaServicios();
                alert(data.mensaje || 'Estado del servicio actualizado correctamente.');
            } else {
                alert(data.mensaje || 'Error al cambiar el estado del servicio.');
            }
        })
        .catch(err => {
            console.error('Error cambiando estado:', err);
            alert('Error al cambiar el estado del servicio.');
        });
    };

    const btnActualizarServicios = document.getElementById('btnActualizarServicios');
    const btnFiltrarServicios = document.getElementById('btnFiltrarServicios');
    if (btnActualizarServicios) {
        btnActualizarServicios.addEventListener('click', function() {
            cargarListaServicios();
        });
    }
    if (btnFiltrarServicios) {
        btnFiltrarServicios.addEventListener('click', function() {
            cargarListaServicios();
        });
    }

    // ---------- Facturaci칩n y Ganancias ----------
    let graficoLinea = null;
    let graficoBarras = null;
    let graficoPastel = null;

    // Cargar parqueaderos en el filtro
    function cargarParqueaderosFiltro() {
        const filtroParqueadero = document.getElementById('filtroParqueadero');
        fetch('/obtener-parqueaderos-activos')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    filtroParqueadero.innerHTML = '<option value="">Todos los parqueaderos</option>';
                    data.parqueaderos.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id_parqueadero;
                        option.textContent = p.nombre;
                        filtroParqueadero.appendChild(option);
                    });
                }
            })
            .catch(err => console.error('Error cargando parqueaderos:', err));
    }

    // Establecer fechas por defecto (칰ltimos 30 d칤as)
    function establecerFechasPorDefecto() {
        const hoy = new Date();
        const hace30Dias = new Date();
        hace30Dias.setDate(hace30Dias.getDate() - 30);
        
        document.getElementById('filtroFechaFin').value = hoy.toISOString().split('T')[0];
        document.getElementById('filtroFechaInicio').value = hace30Dias.toISOString().split('T')[0];
    }

    function cargarDatosFacturacion() {
        const fechaInicio = document.getElementById('filtroFechaInicio').value;
        const fechaFin = document.getElementById('filtroFechaFin').value;
        const idParqueadero = document.getElementById('filtroParqueadero').value;

        const params = new URLSearchParams();
        if (fechaInicio) params.append('fechaInicio', fechaInicio);
        if (fechaFin) params.append('fechaFin', fechaFin);
        if (idParqueadero) params.append('idParqueadero', idParqueadero);

        fetch(`/estadisticas-facturacion?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    actualizarResumen(data.resumen);
                    actualizarGraficos(data.graficos);
                    mostrarTablaFacturas(data.facturas);
                }
            })
            .catch(err => {
                console.error('Error cargando datos de facturaci칩n:', err);
            });
    }

    function actualizarResumen(resumen) {
        document.getElementById('totalFacturado').textContent = 
            `$${parseFloat(resumen.total || 0).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('promedioDiario').textContent = 
            `$${parseFloat(resumen.promedioDiario || 0).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('totalFacturas').textContent = resumen.totalFacturas || 0;
        document.getElementById('mejorDia').textContent = resumen.mejorDia || '-';
    }

    function actualizarGraficos(graficos) {
        // Destruir gr치ficos anteriores
        if (graficoLinea) graficoLinea.destroy();
        if (graficoBarras) graficoBarras.destroy();
        if (graficoPastel) graficoPastel.destroy();

        // Gr치fico de L칤nea - Ganancias por D칤a
        const ctxLinea = document.getElementById('graficoLinea').getContext('2d');
        graficoLinea = new Chart(ctxLinea, {
            type: 'line',
            data: {
                labels: graficos.porDia.labels || [],
                datasets: [{
                    label: 'Ganancias ($)',
                    data: graficos.porDia.valores || [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-CO');
                            }
                        }
                    }
                }
            }
        });

        // Gr치fico de Barras - Ganancias por Parqueadero
        const ctxBarras = document.getElementById('graficoBarras').getContext('2d');
        graficoBarras = new Chart(ctxBarras, {
            type: 'bar',
            data: {
                labels: graficos.porParqueadero.labels || [],
                datasets: [{
                    label: 'Ganancias ($)',
                    data: graficos.porParqueadero.valores || [],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(255, 159, 64, 0.6)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-CO');
                            }
                        }
                    }
                }
            }
        });

        // Gr치fico de Pastel - Ganancias por Tipo de Veh칤culo
        const ctxPastel = document.getElementById('graficoPastel').getContext('2d');
        graficoPastel = new Chart(ctxPastel, {
            type: 'pie',
            data: {
                labels: graficos.porTipoVehiculo.labels || [],
                datasets: [{
                    data: graficos.porTipoVehiculo.valores || [],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': $' + value.toLocaleString('es-CO') + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    function mostrarTablaFacturas(facturas) {
        const tablaFacturas = document.getElementById('tablaFacturas');
        
        if (!facturas || facturas.length === 0) {
            tablaFacturas.innerHTML = '<div class="no-vehiculos">No hay facturas en el rango seleccionado.</div>';
            return;
        }

        tablaFacturas.innerHTML = `
            <table class="tabla-vehiculos">
                <thead>
                    <tr>
                        <th>ID Factura</th>
                        <th>Fecha</th>
                        <th>Parqueadero</th>
                        <th>Placa</th>
                        <th>Tipo Veh칤culo</th>
                        <th>Valor Total</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    ${facturas.map(f => {
                        const tipoVehiculoNombre = {
                            'Automovil': 'Autom칩vil',
                            'Motocicleta': 'Motocicleta',
                            'Camion': 'Cami칩n',
                            'Bicicleta': 'Bicicleta'
                        }[f.tipo_vehiculo] || f.tipo_vehiculo || '-';
                        
                        return `
                            <tr>
                                <td><strong>#${f.id_factura}</strong></td>
                                <td>${f.fecha_emision || '-'}</td>
                                <td>${f.nombre_parqueadero || '-'}</td>
                                <td>${f.placa || '-'}</td>
                                <td>${tipoVehiculoNombre}</td>
                                <td>$${parseFloat(f.valor_total || 0).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td><span class="estado-${f.estado_factura === 'Pendiente' ? 'pendiente' : 'pagado'}">${f.estado_factura || '-'}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    // Event listeners
    const btnActualizarFacturacion = document.getElementById('btnActualizarFacturacion');
    if (btnActualizarFacturacion) {
        btnActualizarFacturacion.addEventListener('click', function() {
            cargarDatosFacturacion();
        });
    }

    const btnAplicarFiltros = document.getElementById('btnAplicarFiltros');
    if (btnAplicarFiltros) {
        btnAplicarFiltros.addEventListener('click', function() {
            cargarDatosFacturacion();
        });
    }

    // Inicializar al cargar la p치gina
    cargarParqueaderosFiltro();
    establecerFechasPorDefecto();

    // ---------- Gesti칩n de Tickets ----------
    function cargarTickets() {
        const estado = document.getElementById('filtroTicketEstado').value;
        const idParqueadero = document.getElementById('filtroTicketParqueadero').value;
        const placa = document.getElementById('filtroTicketPlaca').value.trim();

        const params = new URLSearchParams();
        if (estado) params.append('estado', estado);
        if (idParqueadero) params.append('idParqueadero', idParqueadero);
        if (placa) params.append('placa', placa);

        const tablaTickets = document.getElementById('tablaTickets');
        tablaTickets.innerHTML = '<div class="loading-vehiculos">Cargando tickets...</div>';

        fetch(`/obtener-tickets?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    mostrarTickets(data.tickets);
                } else {
                    tablaTickets.innerHTML = '<div class="no-vehiculos">No se pudieron cargar los tickets.</div>';
                }
            })
            .catch(err => {
                console.error('Error cargando tickets:', err);
                tablaTickets.innerHTML = '<div class="no-vehiculos">Error al cargar los tickets.</div>';
            });
    }

    function mostrarTickets(tickets) {
        const tablaTickets = document.getElementById('tablaTickets');
        
        if (!tickets || tickets.length === 0) {
            tablaTickets.innerHTML = '<div class="no-vehiculos">No hay tickets que coincidan con los filtros.</div>';
            return;
        }

        tablaTickets.innerHTML = `
            <table class="tabla-vehiculos">
                <thead>
                    <tr>
                        <th>ID Ticket</th>
                        <th>Placa</th>
                        <th>Tipo Veh칤culo</th>
                        <th>Parqueadero</th>
                        <th>Hora Entrada</th>
                        <th>Hora Salida</th>
                        <th>Tiempo Estacionado</th>
                        <th>Monto Total</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    ${tickets.map(t => {
                        const tipoVehiculoNombre = {
                            'Automovil': 'Autom칩vil',
                            'Motocicleta': 'Motocicleta',
                            'Camion': 'Cami칩n',
                            'Bicicleta': 'Bicicleta'
                        }[t.tipo_vehiculo] || t.tipo_vehiculo || '-';
                        
                        const horaEntrada = t.hora_entrada ? new Date(t.hora_entrada).toLocaleString('es-CO') : '-';
                        const horaSalida = t.hora_salida ? new Date(t.hora_salida).toLocaleString('es-CO') : '-';
                        
                        let tiempoEstacionado = '-';
                        if (t.hora_entrada) {
                            const entrada = new Date(t.hora_entrada);
                            const salida = t.hora_salida ? new Date(t.hora_salida) : new Date();
                            const diffMs = salida - entrada;
                            const diffMins = Math.floor(diffMs / 60000);
                            const diffHours = Math.floor(diffMins / 60);
                            const diffDays = Math.floor(diffHours / 24);
                            
                            if (diffDays > 0) {
                                tiempoEstacionado = `${diffDays}d ${diffHours % 24}h ${diffMins % 60}m`;
                            } else if (diffHours > 0) {
                                tiempoEstacionado = `${diffHours}h ${diffMins % 60}m`;
                            } else {
                                tiempoEstacionado = `${diffMins}m`;
                            }
                        }
                        
                        const estadoClass = t.estado_ticket === 'Activo' ? 'estado-activo' : 'estado-inactivo';
                        const montoDisplay = t.monto_total ? 
                            `$${parseFloat(t.monto_total).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 
                            '-';
                        
                        return `
                            <tr>
                                <td><strong>#${t.id_ticket}</strong></td>
                                <td>${t.placa || '-'}</td>
                                <td>${tipoVehiculoNombre}</td>
                                <td>${t.nombre_parqueadero || 'Sin parqueadero'}</td>
                                <td>${horaEntrada}</td>
                                <td>${horaSalida}</td>
                                <td>${tiempoEstacionado}</td>
                                <td>${montoDisplay}</td>
                                <td><span class="${estadoClass}">${t.estado_ticket || '-'}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    // Cargar parqueaderos en el filtro de tickets
    function cargarParqueaderosFiltroTickets() {
        const filtroTicketParqueadero = document.getElementById('filtroTicketParqueadero');
        fetch('/obtener-parqueaderos-activos')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    filtroTicketParqueadero.innerHTML = '<option value="">Todos los parqueaderos</option>';
                    data.parqueaderos.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id_parqueadero;
                        option.textContent = p.nombre;
                        filtroTicketParqueadero.appendChild(option);
                    });
                }
            })
            .catch(err => console.error('Error cargando parqueaderos:', err));
    }

    // Event listeners para tickets
    const btnActualizarTickets = document.getElementById('btnActualizarTickets');
    if (btnActualizarTickets) {
        btnActualizarTickets.addEventListener('click', function() {
            cargarTickets();
        });
    }

    const btnAplicarFiltrosTickets = document.getElementById('btnAplicarFiltrosTickets');
    if (btnAplicarFiltrosTickets) {
        btnAplicarFiltrosTickets.addEventListener('click', function() {
            cargarTickets();
        });
    }

    // Inicializar filtros de tickets
    cargarParqueaderosFiltroTickets();
});

// Funciones para limpiar mensajes
function limpiarMensajeIngreso() {
    setTimeout(() => {
        const msgIngreso = document.getElementById('msgIngreso');
        msgIngreso.textContent = '';
        msgIngreso.style.color = '';
    }, 1000);
}

function limpiarMensajeSalida() {
    setTimeout(() => {
        const msgSalida = document.getElementById('msgSalida');
        msgSalida.textContent = '';
        msgSalida.style.color = '';
    }, 1000);
}
</script>
</body>
</html>
